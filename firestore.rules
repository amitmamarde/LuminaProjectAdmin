rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------
    // Helper functions
    // ----------------------------
    function userRole() {
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
        : null;
    }
    function isAdmin() {
      return userRole() == 'Admin';
    }
    function isExpert() {
      let r = userRole();
      return r == 'Expert' || r == 'expert';
    }
    function isUnclaimed(articleData) {
        return !('expertId' in articleData)
            || articleData.expertId == null
            || articleData.expertId == "";
    }

    // ----------------------------
    // /users collection
    // ----------------------------
    match /users/{userId} {
      allow read, update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow create, delete: if isAdmin();
    }

    // ----------------------------
    // /articles collection
    // ----------------------------
    match /articles/{articleId} {
      allow read: if request.auth != null || resource.data.status == 'Published';
      allow create, delete: if isAdmin();

      allow update: if
        isAdmin() ||
        (isExpert() && (

          // --- CONDITION A: Claiming an article ---
          (
            resource.data.status == 'AwaitingExpertReview' &&
            isUnclaimed(resource.data) &&
            request.resource.data.expertId == request.auth.uid &&
            request.resource.data.status == resource.data.status &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['expertId', 'expertDisplayName'])
          )

          ||

          // --- CONDITION B: Submitting a completed review ---
          (
            resource.data.expertId == request.auth.uid &&
            (resource.data.status == 'AwaitingExpertReview' || resource.data.status == 'NeedsRevision') &&
            request.resource.data.status == 'AwaitingAdminReview' &&
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'flashContent', 'deepDiveContent'])
          )
          
          ||

          // --- CONDITION C: Saving a draft (in-progress work). THIS IS THE FIX. ---
          (
            // 1) The user must be the assigned expert.
            resource.data.expertId == request.auth.uid &&
            
            // 2) The article must be in a state where the expert can edit.
            (resource.data.status == 'AwaitingExpertReview' || resource.data.status == 'NeedsRevision') &&
            
            // 3) The status must NOT change during a draft save.
            request.resource.data.status == resource.data.status &&
            
            // 4) The update must ONLY affect the content fields.
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['flashContent', 'deepDiveContent'])
          )
        ));
    }
  }
}
